<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Maps Route</title>
    <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        #info {
            margin-top: 20px;
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
        }
    </style>
    <script>
        mapkit.init({
            authorizationCallback: function (done) {
                done("eyJraWQiOiJMU1pDR0JMR0c1IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJUR004M1FTSEFIIiwiaWF0IjoxNzM2MTk0NzYwLCJvcmlnaW4iOiJieXNhbTA0LmdpdGh1Yi5pbyJ9.LBJ2V_TbE75r68I08JHytaZx5SnlQ8bl4-e_ZUaDavXxtqk_leB_FKnuFaDeODEwjtR2jeKRQI-3p41tLrBkPg");
            }
        });

        function showRoute() {
            const urlParams = new URLSearchParams(window.location.search);
            const start = urlParams.get('start');
            const end = urlParams.get('end');

            if (!start || !end) {
                alert("Bitte Start- und Zielkoordinaten angeben.");
                return;
            }

            let startCoord = new mapkit.Coordinate(...start.split(',').map(Number));
            let endCoord = new mapkit.Coordinate(...end.split(',').map(Number));

            let map = new mapkit.Map("map", {
                showsCompass: mapkit.FeatureVisibility.Visible,
                showsScale: mapkit.FeatureVisibility.Visible,
                center: startCoord,
                region: new mapkit.CoordinateRegion(
                    startCoord,
                    new mapkit.CoordinateSpan(0.5, 0.5)
                )
            });

            let startAnnotation = new mapkit.MarkerAnnotation(startCoord, { title: "Start" });
            let endAnnotation = new mapkit.MarkerAnnotation(endCoord, { title: "Ziel" });
            map.addAnnotations([startAnnotation, endAnnotation]);

            let directions = new mapkit.Directions();
            directions.route(
                {
                    origin: startCoord,
                    destination: endCoord,
                    transportType: mapkit.Directions.Transport.Automobile
                },
                (error, data) => {
                    if (error) {
                        console.error("Fehler bei der Routenberechnung:", error);
                        alert("Fehler bei der Routenberechnung: " + error.message);
                        return;
                    }

                    let route = data.routes[0];
                    console.log("Route-Daten:", route);

                    let points = [];
                    for (let step of route.steps) {
                        points.push(...step.path);
                    }

                    let polyline = new mapkit.PolylineOverlay(points, {
                        style: new mapkit.Style({
                            lineWidth: 5,
                            strokeColor: "#007aff",
                            strokeOpacity: 0.8
                        })
                    });

                    map.addOverlay(polyline);
                    map.showItems([polyline]);

                    const infoDiv = document.getElementById("info");
                    const distanceInKm = (route.distance / 1000).toFixed(2);
                    const travelTimeInMinutes = Math.round(route.expectedTravelTime / 60);

                    // Erstelle einen Link zur Apple Maps App
                    const appleMapsLink = `https://maps.apple.com/?saddr=${start}&daddr=${end}`;

                    let routeDetails = `
                        <p><strong>Entfernung:</strong> ${distanceInKm} km</p>
                        <p><strong>Reisezeit:</strong> ${travelTimeInMinutes} Minuten</p>
                        <p><strong>Routenführung:</strong></p>
                        <ul>
                    `;

                    for (let step of route.steps) {
                        routeDetails += `<li>${step.instructions}</li>`;
                    }
                    routeDetails += `</ul>`;
                    routeDetails += `<p><a href="${appleMapsLink}" target="_blank">Route in Apple Maps öffnen</a></p>`;
                    infoDiv.innerHTML = routeDetails;
                }
            );
        }
    </script>
</head>
<body onload="showRoute()">
    <h1>Apple Maps Route</h1>
    <div id="map"></div>
    <div id="info"></div>
</body>
</html>
